<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Recorrido Ayacucho — Juego</title>

<style>
:root{ --accent:#00c0ff; --panel:rgba(0,0,0,0.55); }
body{ margin:0; font-family:Inter,Arial,sans-serif; background:#071126; color:#e6f6ff; overflow:hidden; }

canvas{ 
  display:block; 
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
}

/* HUD */
.hud{ position:fixed; left:12px; top:12px; z-index:999; background:var(--panel); padding:10px 12px; border-radius:10px; color:#bfeaff; box-shadow:0 6px 20px rgba(0,0,0,0.6); }
.hud .line{ font-size:14px; margin:4px 0; }

/* Controls */
.controlsUI{ position:fixed; right:12px; top:12px; z-index:999; background:var(--panel); padding:10px 12px; border-radius:10px; color:#bfeaff; box-shadow:0 6px 20px rgba(0,0,0,0.6); }
.btn{ display:inline-block; background:var(--accent); color:#042b34; padding:8px 12px; border-radius:10px; font-weight:700; text-decoration:none; margin:6px 4px; cursor:pointer; }

/* Center */
#centerBox{ 
  position:fixed; 
  left:50%; 
  top:50%; 
  transform:translate(-50%,-50%); 
  z-index:1001; 
  background:rgba(0,0,0,0.82); 
  padding:18px; 
  border-radius:12px; 
  text-align:center; 
  width:340px; 
  color:#e6f6ff; 
}

/* Modal preguntas */
#questionModal{ position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); z-index:2000; background:rgba(2,10,20,0.95); padding:18px; border-radius:12px; width:360px; display:none; color:#e6f6ff; }
.optionBtn{ display:block; width:100%; text-align:left; padding:10px; margin:8px 0; border-radius:8px; background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.06); cursor:pointer; }
.small{ font-size:13px; color:#cfefff; }
</style>
</head>

<body>
<canvas id="c"></canvas>

<!-- HUD -->
<div class="hud">
  <div class="line">🚗 Recorrido Ayacucho</div>
  <div class="line">Combustible: <span id="fuel">100</span>% • Vida: <span id="life">100</span>%</div>
  <div class="line">Puntos: <span id="score">0</span></div>
</div>

<!-- Controls -->
<div class="controlsUI">
  <div style="font-weight:700;margin-bottom:6px">Controles</div>
  <div style="font-size:13px">WASD / Flechas • SPACE Acelerar • Ctrl Freno</div>
  <div style="margin-top:8px">
    <a class="btn" id="restartBtn">Reiniciar</a>
    <a class="btn" id="backBtn" href="index.html">Volver</a>
  </div>
</div>

<!-- Start box -->
<div id="centerBox">
  <div id="centerText" style="font-size:18px;margin-bottom:8px">Inicio: Ciudadela Warpa Picchu → Meta: Villa Automation SAC</div>
  <a class="btn" id="startBtn">Iniciar</a>
</div>

<!-- Preguntas -->
<div id="questionModal">
  <div id="qText"></div>
  <div id="qOptions"></div>
  <div style="margin-top:8px;text-align:right">
    <a class="btn" id="skipBtn">Saltar (-10 vida)</a>
  </div>
</div>

<script>
// CANVAS
const canvas = document.getElementById('c'), ctx = canvas.getContext('2d');
let W = canvas.width = window.innerWidth, H = canvas.height = window.innerHeight;
window.addEventListener('resize', ()=>{ W = canvas.width = window.innerWidth; H = canvas.height = window.innerHeight; puntosEnPixeles(); });

// --- MAPA FIJO ---
const mapImg = new Image();
mapImg.src = "assets/mapa.png";

// --- AUTO ---
const carImg = new Image();
carImg.src = "assets/carro1.png";

let car = { x:0, y:0, angle:0, vx:0, vy:0, w:70, h:38 };

// --- PUNTOS REALES ---
let puntos = [
  { nombre: "Ciudadela Warpa Picchu", x:0.50, y:0.88, id:"warpa" },
  { nombre: "Parque Miraflores",     x:0.49, y:0.72 },
  { nombre: "Terminal Sur",          x:0.52, y:0.63 },
  { nombre: "Hospital Arequipa",     x:0.44, y:0.55 },
  { nombre: "MiskyFro",              x:0.45, y:0.52 },
  { nombre: "EMADI",                 x:0.41, y:0.47 },
  { nombre: "Aeropuerto",            x:0.57, y:0.33 },
  { nombre: "Villa Automation SAC",  x:0.47, y:0.37, id:"meta" }
];

// Normalización
function puntosEnPixeles(){
  puntos.forEach(p=>{
    p.X = p.x * W;
    p.Y = p.y * H;
  });
}
puntosEnPixeles();

// Estado
let actual = 0;
let running = false;
let keys = {};
let fuel = 100, life = 100, score = 0;

// Preguntas
function generarPregunta(){
  let a = Math.floor(Math.random()*30)+5;
  let b = Math.floor(Math.random()*15)+2;
  let ans = a + b;
  let opciones = [ans, ans+5, ans-3, ans+8].sort(()=>Math.random()-0.5);

  return { q:`¿Cuánto es ${a} + ${b}?`, ans:String(ans), opciones };
}

// HUD refs
const fuelEl = document.getElementById('fuel');
const lifeEl = document.getElementById('life');
const scoreEl = document.getElementById('score');

// MODALES
const modal = document.getElementById('questionModal');
const qText = document.getElementById('qText');
const qOptions = document.getElementById('qOptions');

// Dibujar escena
function draw(){
  ctx.clearRect(0,0,W,H);

  if(mapImg.complete){
    const scale = Math.max(W/mapImg.width, H/mapImg.height);
    const iw = mapImg.width*scale;
    const ih = mapImg.height*scale;
    ctx.drawImage(mapImg, (W - iw)/2, (H - ih)/2, iw, ih);
  }

  // puntos
  puntos.forEach((p,i)=>{
    ctx.beginPath();
    ctx.fillStyle = (i <= actual) ? "#00ff7b" : "white";
    ctx.arc(p.X, p.Y, 8, 0, Math.PI*2);
    ctx.fill();

    ctx.fillStyle="white";
    ctx.font="12px Arial";
    ctx.fillText(p.nombre, p.X+10, p.Y-10);
  });

  // auto
  ctx.save();
  ctx.translate(car.x, car.y);
  ctx.rotate(car.angle);
  ctx.drawImage(carImg, -car.w/2, -car.h/2, car.w, car.h);
  ctx.restore();
}

// Bucle
function loop(){
  if(!running) return;

  // controles
  if(keys["ArrowLeft"]||keys["a"]) car.angle -= 0.04;
  if(keys["ArrowRight"]||keys["d"]) car.angle += 0.04;

  if((keys["w"]||keys["ArrowUp"]||keys[" "]) && fuel>0){
    car.vx += Math.cos(car.angle)*0.4;
    car.vy += Math.sin(car.angle)*0.4;
    fuel -= 0.06;
  } else {
    car.vx *= 0.98;
    car.vy *= 0.98;
  }

  car.x += car.vx;
  car.y += car.vy;

  // HUD
  fuelEl.innerText = fuel.toFixed(0);
  lifeEl.innerText = life.toFixed(0);
  scoreEl.innerText = score.toFixed(0);

  // proximidad punto
  const p = puntos[actual];
  if(Math.hypot(car.x - p.X, car.y - p.Y) < 35){
    abrirPregunta();
  }

  draw();
  requestAnimationFrame(loop);
}

// preguntas
function abrirPregunta(){
  running = false;
  const pq = generarPregunta();
  modal.style.display = "block";
  qText.innerText = pq.q;
  qOptions.innerHTML = "";

  pq.opciones.forEach(op=>{
    let b = document.createElement("button");
    b.className="optionBtn";
    b.innerText = op;
    b.onclick = ()=>resolver(op, pq.ans);
    qOptions.appendChild(b);
  });
}

function resolver(op, ans){
  if(String(op) === String(ans)){
    score += 150;
    actual++;

    if(puntos[actual] && puntos[actual].id==="meta"){
      modal.style.display="none";
      victory();
      return;
    }
  } else {
    life -= 15;
  }

  modal.style.display="none";
  running = true;
  loop();
}

function victory(){
  running = false;
  alert("🎉 ¡MISIÓN COMPLETADA! Llegaste a Villa Automation SAC");
}

// eventos
window.onkeydown = e => keys[e.key]=true;
window.onkeyup = e => keys[e.key]=false;

// iniciar
document.getElementById("startBtn").onclick = ()=>{
  car.x = puntos[0].X;
  car.y = puntos[0].Y;
  running = true;
  document.getElementById("centerBox").style.display="none";
  loop();
};

document.getElementById("restartBtn").onclick = ()=> location.reload();

// **MOSTRAR PANEL INICIAL**
document.getElementById("centerBox").style.display = "block";

draw();
</script>
</body>
</html>
